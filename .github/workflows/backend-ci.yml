name: Backend CI

on:
  push:
    paths:
      - 'fullstack/backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    paths:
      - 'fullstack/backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  launch-typedb-cloud:
    name: Launch TypeDB Cloud cluster
    runs-on: ubuntu-latest

    outputs:
      address: ${{ steps.launch.outputs.address }}

    steps:
      - name: Launch Cluster
        env:
          TEAM_ID: ${{ vars.TYPEDB_CLOUD_TEAM_ID }}
          SPACE_ID: ${{ vars.TYPEDB_CLOUD_SPACE_ID }}
        id: launch
        run: |
          CLOUD_API_KEY=$(curl --fail-with-body --request POST \
            --url https://cloud.typedb.com/api/auth \
            --header "Authorization: Basic ${{ vars.TYPEDB_CLOUD_CLIENT_ID }}:${{ secrets.TYPEDB_CLOUD_CLIENT_SECRET }}")
          
          CLUSTER_ID=$(echo ${{ github.sha }} | head -c10)
          
          echo "Launching $CLUSTER_ID in $TEAM_ID/$SPACE_ID"
          
          CLUSTER_RES=$(curl --request POST \
            --url https://cloud.typedb.com/api/team/$TEAM_ID/spaces/$SPACE_ID/clusters/deploy \
            --header "Authorization: Bearer $CLOUD_API_KEY" \
            --json "{\"id\":\"$CLUSTER_ID\",\"serverCount\":1,\"storageSizeGB\":10,\"provider\":\"gcp\",\"region\":\"europe-west2\",\"isFree\":false,\"machineType\":\"c2d-highcpu-2\",\"storageType\":\"standard-rwo\",\"version\":\"3.5.1\",\"backupConfiguration\":{\"frequency\":\"disabled\",\"retentionDays\":7}}")
          
          while [[ $(echo $CLUSTER_RES | jq -r '.status') != 'running' ]]; do 
            echo
            echo $CLUSTER_RES | jq
            if [[ $(echo $CLUSTER_RES | jq -r '.message') != null ]]; then exit 1; fi
            echo
            echo "sleeping"
            sleep 30
            CLUSTER_RES=$(curl --request GET \
              --url https://cloud.typedb.com/api/team/$TEAM_ID/spaces/$SPACE_ID/clusters/$CLUSTER_ID \
              --header "Authorization: Bearer $CLOUD_API_KEY")
          done
          
          ADDRESS=$(echo $RES | jq -r '.servers[0].address')
          
          echo "cluster_id=$CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "address=$ADDRESS" >> $GITHUB_OUTPUT

  test-backends:
    name: Test Backend (${{ matrix.backend }})
    needs: launch-typedb-cloud
    runs-on: ubuntu-latest
    env:
      TYPEDB_ADDRESS: ${{ needs.launch.outputs.address }}
    strategy:
      matrix:
        backend:
#          - java
          - python
#          - rust
        include:
#          - backend: java
#            working-directory: fullstack/backend/java
          - backend: python
            working-directory: fullstack/backend/python
#          - backend: rust
#            working-directory: fullstack/backend/rust
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 17 (Java only)
      if: matrix.backend == 'java'
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python (Python only)
      if: matrix.backend == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Rust (Rust only)
      if: matrix.backend == 'rust'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy

    - name: Install dependencies (Python)
      if: matrix.backend == 'python'
      working-directory: ${{ matrix.working-directory }}
      run: |
        python -m pip install --upgrade pip
        pip3 install -r requirements.txt

    # Run the API tests against the running backend
    - name: Run API tests
      working-directory: ${{ github.workspace }}
      run: |
        # Start the backend in the background
        cd ${{ matrix.working-directory }}
        case ${{ matrix.backend }} in
          java)
            ./gradlew bootRun &
            BACKEND_PID=$!
            ;;
          python)
            python app.py &
            BACKEND_PID=$!
            ;;
          rust)
            cargo run &
            BACKEND_PID=$!
            ;;
        esac
        
        # Give the backend time to start
        sleep 15
        
        # Install test dependencies
        cd ${{ github.workspace }}
        pip install -r fullstack/backend/tests/requirements.txt
        
        # Run the API tests against the backend
        echo "Running API tests against ${{ matrix.backend }} backend"
        PYTHONPATH=$PYTHONPATH:${{ github.workspace }}/fullstack/backend/tests \
          pytest fullstack/backend/tests/ -v \
          --base-url=http://localhost:8000 \
          --html=test-report-${{ matrix.backend }}.html \
          --self-contained-html
        
        # Clean up
        kill $BACKEND_PID

  destroy-typedb-cloud:
    name: Destroy TypeDB Cloud cluster
    needs: test-backends
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Destroy Cluster
        env:
          TEAM_ID: ${{ vars.TYPEDB_CLOUD_TEAM_ID }}
          SPACE_ID: ${{ vars.TYPEDB_CLOUD_SPACE_ID }}
        id: destroy
        run: |
          CLOUD_API_KEY=$(curl --fail-with-body --request POST \
            --url https://cloud.typedb.com/api/auth \
            --header "Authorization: Basic ${{ vars.TYPEDB_CLOUD_CLIENT_ID }}:${{ secrets.TYPEDB_CLOUD_CLIENT_SECRET }}")
          
          CLUSTER_ID=$(echo ${{ github.sha }} | head -c10)
          echo "Destroying $CLUSTER_ID in $TEAM_ID/$SPACE_ID"
          
          curl --fail-with-body --request DELETE \
            --url https://cloud.typedb.com/api/team/$TEAM_ID/spaces/$SPACE_ID/clusters/$CLUSTER_ID \
            --header "Authorization: Bearer $CLOUD_API_KEY"

  # This job runs the full test suite against all backends with test reports
  test-reports:
    name: Test Reports
    needs: test-backends
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          test-reports/test-report-*.html

    - name: Check test results
      if: contains(needs.*.result, 'failure')
      run: |
        echo "Some tests failed. Check the test reports for details."
        exit 1
